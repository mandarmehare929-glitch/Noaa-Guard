<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NOAA-GUARD | Satellite Defense System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --neon-blue: #00d4ff; --bg-dark: #0d1117; --alert-red: #ff4d4d; --safe-green: #4dff88; }
        body { background-color: var(--bg-dark); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: rgba(0,0,0,0.4); border-right: 1px solid #333; padding: 25px; display: flex; flex-direction: column; }
        .sidebar h2 { color: var(--neon-blue); font-size: 1.4rem; letter-spacing: 2px; margin-bottom: 40px; border-bottom: 2px solid var(--neon-blue); padding-bottom: 10px; }
        .menu-item { padding: 15px; cursor: pointer; border-radius: 8px; margin-bottom: 12px; transition: 0.3s; color: #8b949e; font-weight: 500; }
        .menu-item:hover, .menu-item.active { background: rgba(0,212,255,0.15); color: white; border-left: 5px solid var(--neon-blue); }

        /* Main Content */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; background: radial-gradient(circle at center, #1a1f2b 0%, #0d1117 100%); }
        .grid-container { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        
        .card { background: rgba(255, 255, 255, 0.03); border-radius: 15px; padding: 25px; border: 1px solid #333; backdrop-filter: blur(10px); }
        .sun-image-box img { width: 100%; border-radius: 10px; border: 1px solid var(--neon-blue); box-shadow: 0 0 25px rgba(0,212,255,0.2); }

        .speed-val { font-size: 3.5rem; color: var(--neon-blue); font-weight: bold; text-shadow: 0 0 25px var(--neon-blue); }
        .protection-status { margin-top: 15px; padding: 10px; border-radius: 5px; font-weight: bold; text-align: center; font-size: 0.9rem; border: 1px dashed #555; }

        @keyframes alert-flash { from { background: #0d1117; } to { background: #4e0000; } }
        .critical-alert { animation: alert-flash 0.5s infinite alternate; }
    </style>
</head>
<body id="main-body">

    <div class="sidebar">
        <h2>NOAA-GUARD</h2>
        <div class="menu-item active" onclick="showSection('live')">üõ°Ô∏è LIVE MONITOR</div>
        <div class="menu-item" onclick="showSection('history')">üìä 7-DAY DEFENSE LOGS</div>
        <div class="menu-item">‚öôÔ∏è SAT-PROTECT SETTINGS</div>
        <div style="margin-top: auto;">
             <button onclick="window.location.href='index.html'" style="width:100%; background:none; border:1px solid #ff4d4d; color:#ff4d4d; padding:12px; cursor:pointer; border-radius:8px;">EMERGENCY LOGOUT</button>
        </div>
    </div>

    <div class="main-content">
        <div id="live-section" class="grid-container">
            <div class="card">
                <div style="display: flex; justify-content: space-between;">
                    <div>
                        <p style="color: #8b949e; margin: 0; letter-spacing: 1px;">SATELLITE TELEMETRY (PLASMA)</p>
                        <div class="speed-val" id="speed-val">FETCHING...</div>
                        <div id="noaa-badge" style="margin-top:10px; color:var(--safe-green);">NOAA Scale: G0 (Normal)</div>
                    </div>
                    <div id="protection-mode" style="color: var(--safe-green); font-weight:bold; border: 1px solid var(--safe-green); padding: 5px 15px; border-radius: 5px;">SATELLITE STATUS: NOMINAL</div>
                </div>

                <div style="height: 320px; margin-top: 25px;">
                    <canvas id="liveChart"></canvas>
                </div>
                <div style="font-size: 0.8rem; color: #555; margin-top: 15px;" id="last-updated">System Syncing...</div>
            </div>

            <div class="card">
                <p style="color: #8b949e; margin-top: 0; font-size: 0.9rem;">LIVE RADIATION SOURCE (NASA SDO)</p>
                <img id="sun-img" src="https://sdo.gsfc.nasa.gov/assets/img/latest/latest_512_0171.jpg" alt="Sun Image">
                <div class="protection-status" id="sat-advice">ADVICE: ALL SYSTEMS OPERATIONAL</div>
                <p style="font-size: 0.7rem; color: #666; margin-top: 15px;">Monitoring High-Energy Photons (171√Ö). Direct threat to Satellite Solar Panels if speed > 600km/s.</p>
            </div>
        </div>

        <div id="history-section" style="display:none;" class="card">
            <h3 style="color:var(--neon-blue);">Strategic 7-Day Storm Trends</h3>
            <p style="color:#8b949e;">Analyzing historical data to predict upcoming Solar CME impacts.</p>
            <div style="height: 400px;">
                <canvas id="historyChart"></canvas>
            </div>
        </div>
    </div>

<script>
    // 1. Audio and Global Variables
    const alarmSound = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
    alarmSound.loop = true;
    let histChart; // Global variable for history

    // 2. Live Chart Initial Setup
    const ctxLive = document.getElementById('liveChart').getContext('2d');
    const liveChart = new Chart(ctxLive, {
        type: 'line',
        data: { 
            labels: [], 
            datasets: [{ 
                label: 'Speed km/s', 
                data: [], 
                borderColor: '#00d4ff', 
                backgroundColor: 'rgba(0, 212, 255, 0.1)',
                tension: 0.3, 
                fill: true 
            }] 
        },
        options: { responsive: true, maintainAspectRatio: false }
    });

    // 3. The Main Fetching Function
    async function updateDefenseData() {
        try {
            const response = await fetch('https://services.swpc.noaa.gov/products/solar-wind/plasma-5-minute.json');
            const data = await response.json();
            const latest = data[data.length - 1];
            const speed = parseFloat(latest[2]);
            const timestamp = new Date();

            if (!isNaN(speed)) {
                // UI Updates
                document.getElementById('speed-val').innerText = speed.toFixed(2) + " km/s";
                document.getElementById('last-updated').innerText = "Last Sync: " + timestamp.toLocaleTimeString() + " (Satellite Connected)";
                
                // Status & Defense Logic
                const statusBox = document.getElementById('protection-mode');
                if (speed > 550) {
                    statusBox.innerText = "SATELLITE STATUS: ALERT";
                    statusBox.style.color = "#ffeb3b";
                    if (speed > 750) {
                        statusBox.innerText = "CRITICAL: SAFE MODE";
                        statusBox.style.color = "#ff4d4d";
                        document.getElementById('main-body').classList.add('critical-alert');
                        alarmSound.play().catch(() => {});
                    }
                } else {
                    statusBox.innerText = "SATELLITE STATUS: NOMINAL";
                    statusBox.style.color = "#4dff88";
                    document.getElementById('main-body').classList.remove('critical-alert');
                    alarmSound.pause();
                }

                // Update Graph
                if (liveChart.data.labels.length > 15) {
                    liveChart.data.labels.shift();
                    liveChart.data.datasets[0].data.shift();
                }
                liveChart.data.labels.push(timestamp.toLocaleTimeString());
                liveChart.data.datasets[0].data.push(speed);
                liveChart.update();
            }
        } catch (error) {
            console.error("Fetch Error:", error);
            document.getElementById('speed-val').innerText = "OFFLINE";
        }
    }

    // 4. 7-Day History Function
    async function fetchHistoryData() {
        const histContainer = document.getElementById('historyChart').getContext('2d');
        try {
            const res = await fetch('https://services.swpc.noaa.gov/products/solar-wind/plasma-7-day.json');
            const rawData = await res.json();
            const filteredData = rawData.slice(1).filter((_, i) => i % 120 === 0);
            
            const labels = filteredData.map(d => d[0].split(' ')[0]);
            const speeds = filteredData.map(d => parseFloat(d[2]));

            if (histChart) histChart.destroy();
            histChart = new Chart(histContainer, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '7-Day Defense Trend',
                        data: speeds,
                        borderColor: '#00d4ff',
                        fill: false
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        } catch (e) { console.error("History Error", e); }
    }

    // 5. Navigation Control
    window.showSection = function(section) {
        document.getElementById('live-section').style.display = (section === 'live') ? 'grid' : 'none';
        document.getElementById('history-section').style.display = (section === 'history') ? 'block' : 'none';
        
        if (section === 'history') fetchHistoryData();
    };

    // Initialize
    setInterval(updateDefenseData, 30000);
    updateDefenseData();
</script>
</body>
</html>
